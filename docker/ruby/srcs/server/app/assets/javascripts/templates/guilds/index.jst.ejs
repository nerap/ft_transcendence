<div id="sidenav">
    <% if (Transcendence.current_user.toJSON().guild == null) { %>
    <form class="sideform" action="/api/guilds" accept-charset="UTF-8" method="post" data-remote="true">
        Guild name<br/>
        <input autocomplete="off" type="text" name="name" minlength="4" maxlength="12" id="name_id">
        <br>Anagram <i style="font-size:12px;">(5 letters)</i><br/>
        <input autocomplete="off" type="text" name="anagram" minlength="5" maxlength="5">
        <br/>
        <input type="hidden" name="points" value="1000">
        <input type="hidden" name="win" value="0">
        <input type="hidden" name="loose" value="0">
        <input type="hidden" name="war" value="null">
        <input type="hidden" name="owner" value="<%= Transcendence.current_user.id %>">
        <div style="padding:5px;"><button type="submit" name="commit" class="edit">create a guild</button></div>
        <input type="hidden" name="authenticity_token" value="<%= $(`meta[name='csrf-token']`).attr('content') %>">
    </form>
    <% } else { %>
    <% guild = Transcendence.guilds.get(Transcendence.current_user.toJSON().guild).toJSON() %>
    <div class="sideform">
        <div style="padding:5px"><a href="#guilds/<%= Transcendence.current_user.toJSON().guild %>"><button class="edit">my guild</button></a></div>
        <% if (Transcendence.current_user.id == guild.owner) {
            grade = "Master"
        } else if (Transcendence.current_user.toJSON().officer == true) {
            grade = "Officer"
        } else if (Transcendence.current_user.toJSON().member == true) {
            grade = "VIP Member"
        } else {
            grade = "Member"
        } %>
        Grade: <span style="font-family:Impact;"><%= grade %></span><br/>
        Guild score: <span style="font-family:Impact;"><%= guild.points %></span><br/>
        Wars won: <span style="font-family:Impact;"><%= guild.win %></span><br/>
        <form action="/api/guilds/leave_guild" accept-charset="UTF-8" method="post" data-remote="true">
            <input type="hidden" name="current_id" value="<%= Transcendence.current_user.toJSON().id %>">
            <button type="submit" class="edit destroy">leave guild</button>
            <input type="hidden" name="authenticity_token" value="<%= $(`meta[name='csrf-token']`).attr('content') %>">
        </form>
    </div>
    <% if (Transcendence.current_user.id == guild.owner) { %>
        <form class="sideform" action="/api/guilds/<%= Transcendence.current_user.toJSON().guild %>" style="margin-top:0;border-top:none" accept-charset="UTF-8" method="post" data-remote="true">
            <input type="hidden" name="_method" value="patch">
            Edit guild name<br/>
            <input value="<%= guild.name %>" autocomplete="off" type="text" name="name" minlength="4" maxlength="12">
            <br>Edit anagram <i style="font-size:12px;">(5 letters)</i><br/>
            <input value="<%= guild.anagram %>" autocomplete="off" type="text" name="anagram" minlength="5" maxlength="5">
            <br/>
            <div style="padding:5px;"><button type="submit" name="commit" class="edit">edit guild</button></div>
            <input type="hidden" name="authenticity_token" value="<%= $(`meta[name='csrf-token']`).attr('content') %>">
            <button type="button" class="edit destroy" onclick='$("#destroy-modal").show()'>destroy guild</button>
        </form>
    <% } %>
    <% } %>
</div>

<div id="destroy-modal" class="modal">
    <div class="modal-content">
        <span id="close" onclick='$("#destroy-modal").hide()'>&times;</span><br/>
        <div class="modal-header">
            <img class="padlock-image" src="/assets/warning.png">
            Are you sure you want to<br/>destroy this guild ?<br/>
            <i style="font-size:15px">(this action is irreversible)</i>
        </div>
        <br/>
        <form action="/api/guilds/<%= guild.id %>" method="post" data-remote="true">
            <input type="hidden" name="_method" value="delete">
            <input type="hidden" name="authenticity_token" value="<%= $(`meta[name='csrf-token']`).attr('content') %>">
            <button type="submit" name="commit" class="confirm-choice yes">Yes</button>
            <button type="button" class="confirm-choice" onclick='$("#destroy-modal").hide()'>No</button>
        </form>
    </div>
</div>

<div id="users-index" style="margin-left:200px;">
    <table>
        <tr>
            <th>Guild name</th>
            <th>Owner</th>
            <th>Score</th>
        </tr>
        <% if (Transcendence.guilds.length == 0) { %>
            <tr>
                <td colspan="3">There are no guilds !</td>
            </tr>
        <% } %>
        <% Transcendence.guilds.each(function(guild) { %>
        <tr class="users-list">
            <td onclick='document.location = "/#guilds/<%= guild.toJSON().id %>"'>[<%= guild.toJSON().anagram %>] <%= guild.toJSON().name %></td>
            <td onclick='document.location = "/#users/<%= guild.toJSON().owner %>"'><%= Transcendence.users.get(guild.toJSON().owner).toJSON().username %></td>
            <td><%= guild.toJSON().points %></td>
            <% if (Transcendence.current_user.toJSON().guild == null) { %>
            <td class="users-action">
                <form action="/api/guilds/join_guild" method="post" data-remote="true">
                    <button type="submit">join</button>
                    <input value="<%= guild.toJSON().id %>" type="hidden" name="guild_id">
                    <input value="<%= Transcendence.current_user.id %>" type="hidden" name="user_id">
                    <input type="hidden" name="authenticity_token" value="<%= $(`meta[name='csrf-token']`).attr('content') %>">
                </form>
            </td>
            <% } else if (Transcendence.current_user.toJSON().guild == guild.toJSON().id) { %>
            <td class="users-action">
                <form action="/api/guilds/leave_guild" accept-charset="UTF-8" method="post" data-remote="true">
                    <input type="hidden" name="current_id" value="<%= Transcendence.current_user.toJSON().id %>">
                    <button type="submit" class="decline-request">leave</button>
                    <input type="hidden" name="authenticity_token" value="<%= $(`meta[name='csrf-token']`).attr('content') %>">
                </form>
            </td>
            <% } else { %><td></td><% } %>
        </tr>
        <% }) %>
    </table>
</div>
